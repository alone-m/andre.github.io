<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React源码学习笔记 | Andre‘s Bolg</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="img/logo.png">
    <meta name="description" content="Andre's blog">
    
    <link rel="preload" href="/assets/css/0.styles.2b171303.css" as="style"><link rel="preload" href="/assets/js/app.e251629e.js" as="script"><link rel="preload" href="/assets/js/2.115eaafa.js" as="script"><link rel="preload" href="/assets/js/9.f39f269c.js" as="script"><link rel="prefetch" href="/assets/js/3.d1fb2ebd.js"><link rel="prefetch" href="/assets/js/4.8c4a9ffe.js"><link rel="prefetch" href="/assets/js/5.7ce974e9.js"><link rel="prefetch" href="/assets/js/6.961d625e.js"><link rel="prefetch" href="/assets/js/7.be4d5d0d.js"><link rel="prefetch" href="/assets/js/8.96e2dd49.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2b171303.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Andre‘s Bolg" class="logo"> <span class="site-name can-hide">Andre‘s Bolg</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/alone-m/andre.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/alone-m/andre.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">目录结构</a></li><li><a href="/study.html" aria-current="page" class="active sidebar-link">React源码学习笔记</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study.html#react-api-简介" class="sidebar-link">React API 简介</a></li><li class="sidebar-sub-header"><a href="/study.html#必备知识点" class="sidebar-link">必备知识点</a></li><li class="sidebar-sub-header"><a href="/study.html#children" class="sidebar-link">Children</a></li><li class="sidebar-sub-header"><a href="/study.html#createref" class="sidebar-link">CreateRef</a></li><li class="sidebar-sub-header"><a href="/study.html#component-purecomponent" class="sidebar-link">Component &amp;&amp; PureComponent</a></li><li class="sidebar-sub-header"><a href="/study.html#creatcontent" class="sidebar-link">CreatContent</a></li><li class="sidebar-sub-header"><a href="/study.html#forwardref" class="sidebar-link">ForwardRef</a></li><li class="sidebar-sub-header"><a href="/study.html#lazy" class="sidebar-link">Lazy</a></li><li class="sidebar-sub-header"><a href="/study.html#memo" class="sidebar-link">memo</a></li><li class="sidebar-sub-header"><a href="/study.html#hooks" class="sidebar-link">Hooks</a></li></ul></li><li><a href="/prototype.html" class="sidebar-link">自学前端遇到的面试题的整理</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react源码学习笔记"><a href="#react源码学习笔记" class="header-anchor">#</a> React源码学习笔记</h1> <h2 id="react-api-简介"><a href="#react-api-简介" class="header-anchor">#</a> React API 简介</h2> <blockquote><p>自从Facebook把React和ReactDOM分包发布之后，React就不仅仅是一开始的前端框架了。目前大部分的框架逻辑都放在了ReactDom里面。
本文的React版本是<code>V17.0.1</code>。借用React官网的一段话来介绍<code>什么是React</code>。</p></blockquote> <blockquote><p>React是一个用于构建用户界面的JavaScript库。</p></blockquote> <blockquote><p>声明式： React使创建交互式UI变得轻松自如。为应用程序中的每个状态设计简单的视图，当数据更改时，React将有效地更新和呈现正确的组件。声明式视图使您的代码更具可预测性，更易于理解和易于调试。</p></blockquote> <blockquote><p>基于组件：构建封装的组件，以管理其自身的状态，然后将它们组合成复杂的UI。由于组件逻辑是用JavaScript而不是模板编写的，因此您可以轻松地通过应用程序传递丰富的数据并将状态保持在DOM之外。</p></blockquote> <blockquote><p>一次学习，随处编写：我们不会对您的其余技术栈做任何假设，因此您可以在React中开发新功能而无需重写现有代码。React还可以使用Node在服务器上进行渲染，并使用React Native来支持移动应用程序。</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token punctuation">{</span>
  Children <span class="token operator">=</span> <span class="token punctuation">{</span>
    map<span class="token punctuation">,</span>  
    forEach<span class="token punctuation">,</span>
    count<span class="token punctuation">,</span>
    toArray<span class="token punctuation">,</span>
    only<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  createRef<span class="token punctuation">,</span>
  Component<span class="token punctuation">,</span>
  PureComponent<span class="token punctuation">,</span>
  createContext<span class="token punctuation">,</span>
  forwardRef<span class="token punctuation">,</span>
  lazy<span class="token punctuation">,</span>
  memo<span class="token punctuation">,</span>
  useCallback<span class="token punctuation">,</span>
  useContext<span class="token punctuation">,</span>
  useEffect<span class="token punctuation">,</span>
  useImperativeHandle<span class="token punctuation">,</span>
  useDebugValue<span class="token punctuation">,</span>
  useLayoutEffect<span class="token punctuation">,</span>
  useMemo<span class="token punctuation">,</span>
  useReducer<span class="token punctuation">,</span>
  useRef<span class="token punctuation">,</span>
  useState<span class="token punctuation">,</span>
  useMutableSource<span class="token punctuation">,</span> 
  useMutableSource <span class="token keyword">as</span> unstable_useMutableSource<span class="token punctuation">,</span>
  createMutableSource<span class="token punctuation">,</span>
  createMutableSource <span class="token keyword">as</span> unstable_createMutableSource<span class="token punctuation">,</span>
  Fragment<span class="token punctuation">,</span>
  Profiler<span class="token punctuation">,</span>
  unstable_DebugTracingMode<span class="token punctuation">,</span>
  StrictMode<span class="token punctuation">,</span>
  Suspense<span class="token punctuation">,</span>
  createElement<span class="token punctuation">,</span>
  cloneElement<span class="token punctuation">,</span>
  isValidElement<span class="token punctuation">,</span>
  version<span class="token punctuation">,</span>
  __SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED<span class="token punctuation">,</span>
  createFactory<span class="token punctuation">,</span>
  useTransition<span class="token punctuation">,</span>
  useTransition <span class="token keyword">as</span> unstable_useTransition<span class="token punctuation">,</span>
  startTransition<span class="token punctuation">,</span>
  startTransition <span class="token keyword">as</span> unstable_startTransition<span class="token punctuation">,</span>
  useDeferredValue<span class="token punctuation">,</span>
  useDeferredValue <span class="token keyword">as</span> unstable_useDeferredValue<span class="token punctuation">,</span>
  SuspenseList<span class="token punctuation">,</span>
  SuspenseList <span class="token keyword">as</span> unstable_SuspenseList<span class="token punctuation">,</span>
  unstable_LegacyHidden<span class="token punctuation">,</span>
  unstable_createFundamental<span class="token punctuation">,</span>
  unstable_Scope<span class="token punctuation">,</span>
  unstable_useOpaqueIdentifier<span class="token punctuation">,</span>
  unstable_getCacheForType<span class="token punctuation">,</span>
  unstable_Cache<span class="token punctuation">,</span>
  unstable_useCacheRefresh<span class="token punctuation">,</span>
<span class="token punctuation">}</span>  <span class="token keyword">from</span> <span class="token string">'React'</span> 
</code></pre></div><h2 id="必备知识点"><a href="#必备知识点" class="header-anchor">#</a> 必备知识点</h2> <ul><li><code>$$typeof</code>是什么东西？是用来干什么的。</li></ul> <blockquote><p>其实这个东西是为了来防止XSS攻击（不知道的自行百度）。React 0.14 修复手段是在虚拟DOM中添加<code>$$typeof</code>，使用 <code>Symbol</code> 标记每个 React 元素（element）：<code>Symbol</code>类型是非常重要的，因为JSON不支持 <code>Symbol</code> 类型。 所以即使服务器存在用JSON作为文本返回安全漏洞，JSON 里也不包含 <code>Symbol.for('react.element')</code>。React 会检测 <code>element.$$typeof</code>，如果元素丢失或者无效，会拒绝处理该元素。<br> 详情见: https://blog.csdn.net/z591102/article/details/108531302</p></blockquote> <h2 id="children"><a href="#children" class="header-anchor">#</a> Children</h2> <p>这个对象提供了一系列处理props.children的方法，用来将<code>ReactNodeList</code>的处理成一个数组。这样就方便于我们自己去对children进行一系列操作。</p> <blockquote><p><code>React.children.map</code>的用法<code>React.Children.map(props.children,(child)=&gt;{ })</code>。第一个参数是父组件的<code>props.children</code>，第二个参数是源码中定义的 <code>MapFunc</code> 返回一个回调函数，提供一个参数<code>child:?React$Node</code>。</p></blockquote> <h2 id="createref"><a href="#createref" class="header-anchor">#</a> CreateRef</h2> <p>新的<code>ref</code>用法，React即将抛弃<code>&lt;div ref=&quot;myDiv&quot; /&gt;</code>这种<code>string ref</code>的用法，将来你只能使用两种方式来使用ref。<code>createRef</code>的源码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>type RefObject <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">|</span>
  current<span class="token operator">:</span> any<span class="token punctuation">,</span>
<span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// an immutable object with a single mutable value</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> RefObject <span class="token punctuation">{</span>
  <span class="token keyword">const</span> refObject <span class="token operator">=</span> <span class="token punctuation">{</span>
    current<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">seal</span><span class="token punctuation">(</span>refObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> refObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>例子如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Ref例子 class模式</span>
<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>appRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>appRef<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token comment">// or</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">current</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appRef <span class="token operator">=</span> current<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre></div><h2 id="component-purecomponent"><a href="#component-purecomponent" class="header-anchor">#</a> Component &amp;&amp; PureComponent</h2> <p>这两个类是React的组件类。里面会提供一些方法，比如<code>Component.prototype.forceUpdate</code>和<code>Component.prototype.setState</code>。这两个类的区别在于<code>isPureReactComponent</code>属性不一样。<code>Component</code>的<code>isPureReactComponent</code>为<code>{}</code>。<code>PureComponent</code>的<code>isPureReactComponent</code>属性为<code>true</code>。这个属性用来判断是否是继承的<code>PureComponent</code>，如果是的话就<code>shallowEqual</code>比较新旧<code>state</code>和<code>props</code>。React中对比一个ClassComponent是否需要更新，如果是<code>Component</code>组件则是看有没有<code>shouldComponentUpdate</code>方法，然后默认渲染。而如果是<code>PureComponent</code>还需要比较比较新旧<code>state</code>和<code>props</code>。总结来说<code>PureComponent</code>是一个更有性能的<code>Component</code>版本。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//Avoid an extra prototype jump for these methods.</span>
Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>pureComponentPrototype<span class="token punctuation">,</span> <span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
pureComponentPrototype<span class="token punctuation">.</span>isPureReactComponent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="creatcontent"><a href="#creatcontent" class="header-anchor">#</a> CreatContent</h2> <p>这是官方出的<code>context</code>方案。主要是提供了<code>Provide</code>和<code>Consumer</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 源码中用到的方法</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>Consumer<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> <span class="token comment">// 主要是给Consumer对象新增或修改一些属性。</span>
<span class="token comment">//例子</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Provide<span class="token punctuation">,</span>Consumer<span class="token punctuation">}</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">creatContent</span><span class="token punctuation">(</span>defauleValue<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">ProvideDemo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">(</span>
  <span class="token comment">// contextValue 就是传下去的上下文</span>
  <span class="token operator">&lt;</span>Provide value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'contextValue'</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
     <span class="token punctuation">{</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>Provide<span class="token operator">&gt;</span>	
<span class="token punctuation">)</span>
 <span class="token comment">// contextValue 就是传下去的上下文,Consumer会将上下文的数据作为参数传入renderProps渲染的函数之内</span>
<span class="token keyword">const</span> ConsumerDemo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">(</span>
<span class="token operator">&lt;</span>Consumer<span class="token operator">&gt;</span>
    <span class="token punctuation">{</span>
      <span class="token punctuation">(</span><span class="token parameter">contextValue</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token operator">&lt;</span>span<span class="token operator">&gt;</span><span class="token punctuation">{</span>contextValue<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
 <span class="token operator">&lt;</span><span class="token operator">/</span>Consumer<span class="token operator">&gt;</span>
<span class="token punctuation">)</span>
</code></pre></div><h2 id="forwardref"><a href="#forwardref" class="header-anchor">#</a> ForwardRef</h2> <p><code>forwardRef</code>主要是为了来传递ref，将外部的props传入给包裹的组件。</p> <h2 id="lazy"><a href="#lazy" class="header-anchor">#</a> Lazy</h2> <p>懒加载，主要是用来异步加载一些组件。原理是通过<code>import</code>方法，<code>import</code>在<code>webpack</code>中最终会调用<code>requireEnsure</code>方法，动态插入script来请求js文件，类似jsonp的形式。<code>React.lazy</code>不能单独使用，需要配合<code>React.suspense</code>，<code>suspence</code>是用来包裹异步组件，添加<code>loading</code>效果等。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> demo <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./component/Lazy'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//在fallback里面处理loading效果等</span>
<span class="token operator">&lt;</span>React<span class="token punctuation">.</span>suspense fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>loading<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span>demo<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>demo<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>React<span class="token punctuation">.</span>suspense<span class="token operator">&gt;</span>
</code></pre></div><h2 id="memo"><a href="#memo" class="header-anchor">#</a> memo</h2> <p><code>memo</code>其实和<code>PureComponent</code>类似。它是用来创建函数的时候使用的，而<code>PureComponent</code>是在创建类的时候使用的。所以<code>memo</code>大多数用于hook模式，而<code>PureComponent</code>大多数用于class模式。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// memo</span>
<span class="token keyword">const</span> <span class="token function-variable function">children</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token string">'1'</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> demo <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">memo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">//PureComponent</span>
<span class="token keyword">class</span> <span class="token class-name">child</span> extend React<span class="token punctuation">.</span>PureComponent<span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="hooks"><a href="#hooks" class="header-anchor">#</a> Hooks</h2> <p>源码在<code>React Dom</code>的<code>server</code>的<code>ReactPartialRendererHooks</code>中。</p> <ul><li>useState
<code>useState</code>其实只是一个语法糖，底层的东西实际上是<code>useReduce</code>。<br>
1、<code>createWorkInProgressHook</code>创建一个<code>workInProgressHook</code>对象用来判断是否是第一次渲染，如果是则需要进行初始化操作。这里初始化<code>initialState</code>，并且记录在<code>workInProgressHook.memoizedState</code>和<code>workInProgressHook.baseState</code>上</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>   <span class="token comment">// 第一次渲染主要就是初始化操作</span>
    <span class="token keyword">let</span> initialState<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reducer <span class="token operator">===</span> basicStateReducer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Special case for `useState`.</span>
      initialState <span class="token operator">=</span>
        <span class="token keyword">typeof</span> initialArg <span class="token operator">===</span> <span class="token string">'function'</span>
          <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>initialArg<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>initialArg<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">S</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      initialState <span class="token operator">=</span>
        init <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token function">init</span><span class="token punctuation">(</span>initialArg<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>initialArg<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">S</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     workInProgressHook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> initialState<span class="token punctuation">;</span>
    <span class="token keyword">const</span> queue<span class="token operator">:</span> UpdateQueue<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span>workInProgressHook<span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">{</span>
      last<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      dispatch<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> dispatch<span class="token operator">:</span> Dispatch<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>dispatch <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">dispatchAction</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
      currentlyRenderingComponent<span class="token punctuation">,</span>
      queue<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>workInProgressHook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>如果不是，则是re-render。我们在上面的初始化代码中可以看到<code>queue</code>对象其实很简单，就是一个<code>last</code>指针和<code>dispatch</code>方法。<code>dispatch</code>是用来记录更新<code>state</code>的方法的。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// This is a re-render. Apply the new render phase updates to the previous</span>
    <span class="token comment">// current hook.</span>
    <span class="token keyword">const</span> queue<span class="token operator">:</span> UpdateQueue<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span>workInProgressHook<span class="token punctuation">.</span>queue<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> dispatch<span class="token operator">:</span> Dispatch<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>dispatch<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>renderPhaseUpdates <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Render phase updates are stored in a map of queue -&gt; linked list</span>
      <span class="token keyword">const</span> firstRenderPhaseUpdate <span class="token operator">=</span> renderPhaseUpdates<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>firstRenderPhaseUpdate <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        renderPhaseUpdates<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> newState <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
        <span class="token keyword">let</span> update <span class="token operator">=</span> firstRenderPhaseUpdate<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
          <span class="token comment">// Process this render phase update. We don't have to check the</span>
          <span class="token comment">// priority because it will always be the same as the current</span>
          <span class="token comment">// render's.</span>
          <span class="token keyword">const</span> action <span class="token operator">=</span> update<span class="token punctuation">.</span>action<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            isInHookUserCodeInDev <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          newState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>newState<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            isInHookUserCodeInDev <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          update <span class="token operator">=</span> update<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>update <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        workInProgressHook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> newState<span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token punctuation">[</span>newState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 对应我们的 const [state, updateState] = useState('defaultVal')</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>workInProgressHook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>useCallBack、useMemo
<code>useCallBack</code>主要用于处理函数产生不必要的渲染。根据参数<code>deps</code>的内容是否改变，决定是返回存储的老方法，还是返回新的方法并记录。它其实也是一个语法糖，底层的东西是<code>useMemo</code>。</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> useCallback<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  callback<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span>
  deps<span class="token operator">:</span> Array<span class="token operator">&lt;</span>mixed<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> callback<span class="token punctuation">,</span> deps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>useContext
通过Context实例去获取上下文的值。</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 获取到的上下文的值</span>
<span class="token keyword">const</span> context <span class="token operator">=</span> useContext（fidContext）

<span class="token keyword">function</span> useContext<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  context<span class="token operator">:</span> ReactContext<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  observedBits<span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">|</span> number <span class="token operator">|</span> boolean<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentHookNameInDev <span class="token operator">=</span> <span class="token string">'useContext'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">resolveCurrentlyRenderingComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> threadID <span class="token operator">=</span> currentPartialRenderer<span class="token punctuation">.</span>threadID<span class="token punctuation">;</span>
  <span class="token function">validateContextBounds</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> threadID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> context<span class="token punctuation">[</span>threadID<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>useEffect
<code>effect</code> 函数将在 <code>componentDidAmount</code> 时触发和 <code>componentDidUpdate</code> 时有条件触发。可?以返回一个函数(returnFunction)，<code>returnFunction</code> 将会在 <code>componentWillUnmount</code> 时触发和在 <code>componentDidUpdate</code> 时先于 <code>effect</code> 有条件触发。<br>
与 <code>componentDidAmount</code> 和 <code>componentDidUpdate</code> 不同之处是，<code>effect</code> 函数触发时间为在浏览器完成渲染之后。 如果需要在渲染之前触发，需要使用 <code>useLayoutEffect</code>。<br>
第二个参数 array 作为有条件触发情况时的条件限制。<br>
如果不传，则每次 <code>componentDidUpdate</code> 时都会先触发 <code>returnFunction</code>（如果存在），再触发 <code>effect</code>。<br>
如果为空数组[]，<code>componentDidUpdate</code> 时不会触发 <code>returnFunction</code> 和 <code>effect</code>。<br>
如果只需要在指定变量变更时触发 <code>returnFunction</code> 和 <code>effect</code>，将该变量放入数组。</p></li> <li><p>useImperativeHandle
<code>useImperativeHandle</code>的核心其实也是<code>useLayoutEffect</code>的调用，接受一个父组件的ref参数，挂载到Component上。实现父组件通过ref可以调用子组件的方法和变量。</p></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">FancyInput</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> ref</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">useImperativeMethods</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">focus</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span> <span class="token operator">...</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
FancyInput <span class="token operator">=</span>  React<span class="token punctuation">.</span><span class="token function">forwardRef</span><span class="token punctuation">(</span>FancyInput<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/" class="prev router-link-active">
        目录结构
      </a></span> <span class="next"><a href="/prototype.html">
        自学前端遇到的面试题的整理
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e251629e.js" defer></script><script src="/assets/js/2.115eaafa.js" defer></script><script src="/assets/js/9.f39f269c.js" defer></script>
  </body>
</html>
